# Post ë¬´í•œìŠ¤í¬ë¡¤ & ìºì‹œ ì •ê·œí™”

> useInfiniteQuery + Cursor ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜ + ìºì‹œ ì •ê·œí™” íŒ¨í„´ ì •ë¦¬

---

## 1. Offset vs Cursor í˜ì´ì§€ë„¤ì´ì…˜ ë¹„êµ

### Offset ê¸°ë°˜ (ê¸°ì¡´ ë°©ì‹)

```typescript
// Offset ê¸°ë°˜
.range(from, to)  // ì˜ˆ: .range(0, 9), .range(10, 19)

// ë˜ëŠ” SQLë¡œ í‘œí˜„í•˜ë©´
SELECT * FROM posts ORDER BY created_at DESC LIMIT 10 OFFSET 20
```

**ë™ì‘ ë°©ì‹:**
```
í˜ì´ì§€ 1: OFFSET 0,  LIMIT 10 â†’ 1~10ë²ˆì§¸ í–‰
í˜ì´ì§€ 2: OFFSET 10, LIMIT 10 â†’ 11~20ë²ˆì§¸ í–‰
í˜ì´ì§€ 3: OFFSET 20, LIMIT 10 â†’ 21~30ë²ˆì§¸ í–‰
```

**ë¬¸ì œì :**
```
[ì‹œë‚˜ë¦¬ì˜¤] ì‚¬ìš©ìê°€ 1í˜ì´ì§€ë¥¼ ë³´ëŠ” ë™ì•ˆ ìƒˆ ê¸€ 2ê°œê°€ ì¶”ê°€ë¨

ì´ˆê¸° ìƒíƒœ: [A, B, C, D, E, F, G, H, I, J, ...]
1í˜ì´ì§€ ë¡œë“œ: [A, B, C, D, E] (OFFSET 0)

-- ìƒˆ ê¸€ X, Y ì¶”ê°€ --
í˜„ì¬ DB: [X, Y, A, B, C, D, E, F, G, H, I, J, ...]

2í˜ì´ì§€ ë¡œë“œ: [D, E, F, G, H] (OFFSET 5)
              â†‘ â†‘
              ì¤‘ë³µ! D, Eê°€ ë˜ ë‚˜ì˜´
```

---

### Cursor ê¸°ë°˜ (í˜„ì¬ ë°©ì‹)

```typescript
// Cursor ê¸°ë°˜
.lt("id", cursor)  // "idê°€ cursorë³´ë‹¤ ì‘ì€ ê²ƒë§Œ"
.limit(10)

// SQLë¡œ í‘œí˜„í•˜ë©´
SELECT * FROM posts WHERE id < 100 ORDER BY created_at DESC LIMIT 10
```

**ë™ì‘ ë°©ì‹:**
```
í˜ì´ì§€ 1: cursor ì—†ìŒ â†’ ê°€ì¥ ìµœì‹  10ê°œ (id: 100~91)
í˜ì´ì§€ 2: cursor=91  â†’ id < 91ì¸ ê²ƒ ì¤‘ 10ê°œ (id: 90~81)
í˜ì´ì§€ 3: cursor=81  â†’ id < 81ì¸ ê²ƒ ì¤‘ 10ê°œ (id: 80~71)
```

**ìƒˆ ê¸€ ì¶”ê°€ ì‹œ:**
```
[ì‹œë‚˜ë¦¬ì˜¤] ì‚¬ìš©ìê°€ 1í˜ì´ì§€ë¥¼ ë³´ëŠ” ë™ì•ˆ ìƒˆ ê¸€ ì¶”ê°€ë¨

ì´ˆê¸° ìƒíƒœ: [100, 99, 98, 97, 96, ...]
1í˜ì´ì§€ ë¡œë“œ: [100, 99, 98, 97, 96, 95, 94, 93, 92, 91]
             ë§ˆì§€ë§‰ id = 91 â†’ nextCursor = 91

-- ìƒˆ ê¸€ 101, 102 ì¶”ê°€ --
í˜„ì¬ DB: [102, 101, 100, 99, 98, 97, 96, 95, 94, 93, 92, 91, ...]

2í˜ì´ì§€ ë¡œë“œ: WHERE id < 91 â†’ [90, 89, 88, 87, 86, 85, 84, 83, 82, 81]
             âœ… ì¤‘ë³µ ì—†ìŒ! ì •í™•íˆ ë‹¤ìŒ ë°ì´í„°ë§Œ ê°€ì ¸ì˜´
```

---

## 2. ì½”ë“œ ìƒì„¸ ë¶„ì„

### `fetchPosts` - API ë ˆì´ì–´

```typescript
export async function fetchPosts({
  familyId,
  category,
  cursor,      // ğŸ‘ˆ ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ postì˜ id
  limit = PAGE_SIZE,
}: { ... }) {
  
  let query = supabase
    .from("posts")
    .select("*")
    .eq("family_id", familyId)
    .order("created_at", { ascending: false })  // ğŸ‘ˆ ìµœì‹ ìˆœ ì •ë ¬
    .limit(limit);                               // ğŸ‘ˆ 10ê°œì”©

  // ì¹´í…Œê³ ë¦¬ í•„í„°
  if (category === "notice") {
    query = query.eq("is_notice", true);
  } else if (category === "general") {
    query = query.eq("is_notice", false);
  }

  // ğŸ‘‡ í•µì‹¬: Cursor ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜
  if (cursor) {
    query = query.lt("id", cursor);  // idê°€ cursorë³´ë‹¤ ì‘ì€ ê²ƒë§Œ
  }
  // cursorê°€ ì—†ìœ¼ë©´ (ì²« í˜ì´ì§€) ê·¸ëƒ¥ ìµœì‹  10ê°œ

  const { data: posts, error } = await query;
  // ... ìˆ˜ë™ ì¡°ì¸ ë¡œì§
}
```

**`.lt("id", cursor)` ì˜ ì˜ë¯¸:**
- `lt` = Less Than (ë³´ë‹¤ ì‘ì€)
- `cursor`ê°€ 91ì´ë©´ â†’ `WHERE id < 91`
- ì´ë¯¸ ë³¸ ë°ì´í„°(id >= 91)ëŠ” ì œì™¸í•˜ê³  ê·¸ ë‹¤ìŒ ë°ì´í„°ë§Œ ê°€ì ¸ì˜´

---

### `useInfinitePosts` - Hook ë ˆì´ì–´

```typescript
export function useInfinitePosts(familyId: string, category?: PostCategory) {
  const queryClient = useQueryClient();

  return useInfiniteQuery({
    // ğŸ‘‡ ì¿¼ë¦¬ í‚¤: familyIdì™€ category ì¡°í•©
    queryKey: QUERY_KEYS.post.list(familyId, category),
    // â†’ ["post", "list", "family-123", { category: "all" }]
    
    // ğŸ‘‡ ë°ì´í„° fetching í•¨ìˆ˜
    queryFn: async ({ pageParam }) => {
      //                â†‘
      // pageParam = ì´ì „ í˜ì´ì§€ì˜ nextCursor ê°’
      // ì²« í˜ì´ì§€: undefined
      // 2í˜ì´ì§€: 91 (1í˜ì´ì§€ ë§ˆì§€ë§‰ id)
      // 3í˜ì´ì§€: 81 (2í˜ì´ì§€ ë§ˆì§€ë§‰ id)
      
      const posts = await fetchPosts({
        familyId,
        category,
        cursor: pageParam,  // ğŸ‘ˆ pageParamì„ cursorë¡œ ì „ë‹¬
        limit: PAGE_SIZE,
      });

      // ğŸ‘‡ ìºì‹œ ì •ê·œí™”: ê° postë¥¼ byId ìºì‹œì— ì €ì¥
      posts.forEach((post) => {
        queryClient.setQueryData(QUERY_KEYS.post.byId(post.id), post);
        // â†’ ["post", 100] = { id: 100, content: "...", ... }
        // â†’ ["post", 99]  = { id: 99, content: "...", ... }
        // â†’ ...
      });

      // ğŸ‘‡ ë¦¬ìŠ¤íŠ¸ ìºì‹œì—ëŠ” IDë§Œ ì €ì¥
      // ğŸ‘‡ ì—¬ê¸°ì„œ nextCursorë¥¼ ê³„ì‚°í•´ì„œ ë°˜í™˜!
      return {
        ids: posts.map((p) => p.id),  // [100, 99, 98, 97, 96, 95, 94, 93, 92, 91]
        nextCursor: posts.length === PAGE_SIZE 
          ? posts[posts.length - 1].id  // 91 (ë§ˆì§€ë§‰ postì˜ id)
          : undefined,  // ë°ì´í„°ê°€ 10ê°œ ë¯¸ë§Œì´ë©´ ë” ì´ìƒ ì—†ìŒ
      };
    },

    // ğŸ‘‡ ì²« í˜ì´ì§€ì˜ pageParam ê°’
    initialPageParam: undefined as number | undefined,
    
    // ğŸ‘‡ ë‹¤ìŒ í˜ì´ì§€ì˜ pageParamì„ ê²°ì •í•˜ëŠ” í•¨ìˆ˜
    // ğŸ‘‡ ì´ í•¨ìˆ˜ê°€ queryFn ë°˜í™˜ê°’ì—ì„œ nextCursorë¥¼ ì¶”ì¶œ
    getNextPageParam: (lastPage) => lastPage.nextCursor,
    // lastPage.nextCursorê°€ undefinedë©´ hasNextPage = false
    
    staleTime: 1000 * 60 * 5,
    enabled: !!familyId,
  });
}
```

#### íë¦„ ì‹œê°í™”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    useInfiniteQuery ë‚´ë¶€                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1í˜ì´ì§€ ìš”ì²­]
  queryFn({ pageParam: undefined })  â† initialPageParam
       â†“
  fetchPosts({ cursor: undefined }) â†’ posts 10ê°œ ë°˜í™˜
       â†“
  return { ids: [...], nextCursor: 91 }  â† queryFn ë°˜í™˜ê°’
       â†“
  getNextPageParam({ ids, nextCursor: 91 }) â†’ 91 ë°˜í™˜
       â†“
  TanStack Queryê°€ 91ì„ ì €ì¥í•´ë‘  âœ…


[2í˜ì´ì§€ ìš”ì²­] fetchNextPage() í˜¸ì¶œ ì‹œ
  queryFn({ pageParam: 91 })  â† ì €ì¥í•´ë‘” ê°’ì„ ì „ë‹¬!
       â†“
  fetchPosts({ cursor: 91 }) â†’ posts 10ê°œ ë°˜í™˜
       â†“
  return { ids: [...], nextCursor: 81 }
       â†“
  getNextPageParam({ ids, nextCursor: 81 }) â†’ 81 ë°˜í™˜
       â†“
  TanStack Queryê°€ 81ì„ ì €ì¥í•´ë‘  âœ…


[ë§ˆì§€ë§‰ í˜ì´ì§€ ìš”ì²­]
  queryFn({ pageParam: 11 })
       â†“
  fetchPosts({ cursor: 11 }) â†’ posts 3ê°œë§Œ ë°˜í™˜ (10ê°œ ë¯¸ë§Œ)
       â†“
  return { ids: [...], nextCursor: undefined }  â† ë” ì´ìƒ ì—†ìŒ
       â†“
  getNextPageParam({ ids, nextCursor: undefined }) â†’ undefined ë°˜í™˜
       â†“
  hasNextPage = false ë¨ âœ…
```

---

## 3. ì „ì²´ íë¦„ ì‹œê°í™”

### ì²« í˜ì´ì§€ ë¡œë“œ

```
[ì‚¬ìš©ì ì•¡ì…˜] í”¼ë“œ í˜ì´ì§€ ì§„ì…

[useInfinitePosts]
  â†“ queryFn({ pageParam: undefined })
  
[fetchPosts]
  â†“ cursorê°€ ì—†ìœ¼ë¯€ë¡œ ìµœì‹  10ê°œ ì¡°íšŒ
  â†“ SELECT * FROM posts WHERE family_id = '...' 
  â†“         ORDER BY created_at DESC LIMIT 10
  
[DB ì‘ë‹µ]
  posts = [
    { id: 100, content: "ìµœì‹  ê¸€", ... },
    { id: 99, content: "...", ... },
    ...
    { id: 91, content: "...", ... },
  ]

[ìºì‹œ ì •ê·œí™”]
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ["post", 100] â†’ { id: 100, ... }        â”‚
  â”‚ ["post", 99]  â†’ { id: 99, ... }         â”‚
  â”‚ ...                                     â”‚
  â”‚ ["post", 91]  â†’ { id: 91, ... }         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ë¦¬ìŠ¤íŠ¸ ìºì‹œ]
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ["post", "list", familyId, {category}]  â”‚
  â”‚   pages: [                              â”‚
  â”‚     { ids: [100,99,98,...,91],          â”‚
  â”‚       nextCursor: 91 }                  â”‚
  â”‚   ]                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë‘ ë²ˆì§¸ í˜ì´ì§€ ë¡œë“œ (ìŠ¤í¬ë¡¤)

```
[ì‚¬ìš©ì ì•¡ì…˜] ìŠ¤í¬ë¡¤í•˜ì—¬ ë” ë³´ê¸°

[useInfinitePosts]
  â†“ fetchNextPage() í˜¸ì¶œë¨
  â†“ getNextPageParam(lastPage) â†’ 91 ë°˜í™˜
  â†“ queryFn({ pageParam: 91 })

[fetchPosts]
  â†“ cursor = 91
  â†“ SELECT * FROM posts WHERE family_id = '...' 
  â†“         AND id < 91  â† í•µì‹¬!
  â†“         ORDER BY created_at DESC LIMIT 10

[DB ì‘ë‹µ]
  posts = [
    { id: 90, content: "...", ... },
    { id: 89, content: "...", ... },
    ...
    { id: 81, content: "...", ... },
  ]

[ìºì‹œ ì •ê·œí™”]
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ["post", 100] â†’ { ... } (ê¸°ì¡´)          â”‚
  â”‚ ...                                     â”‚
  â”‚ ["post", 91]  â†’ { ... } (ê¸°ì¡´)          â”‚
  â”‚ ["post", 90]  â†’ { ... } (ì‹ ê·œ ì¶”ê°€)     â”‚
  â”‚ ...                                     â”‚
  â”‚ ["post", 81]  â†’ { ... } (ì‹ ê·œ ì¶”ê°€)     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ë¦¬ìŠ¤íŠ¸ ìºì‹œ]
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ["post", "list", familyId, {category}]  â”‚
  â”‚   pages: [                              â”‚
  â”‚     { ids: [100,...,91], nextCursor: 91 }, â† 1í˜ì´ì§€
  â”‚     { ids: [90,...,81], nextCursor: 81 },  â† 2í˜ì´ì§€ ì¶”ê°€
  â”‚   ]                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ìºì‹œ ì •ê·œí™”ì˜ ì´ì 

### Post ìˆ˜ì • ì‹œ

```
[ì‹œë‚˜ë¦¬ì˜¤] id=95 ê²Œì‹œê¸€ ìˆ˜ì •

[Before]
  ["post", 95] â†’ { id: 95, content: "ì›ë³¸ ë‚´ìš©", ... }

[useUpdatePost] onSuccess
  queryClient.setQueryData(["post", 95], updatedPost);

[After]
  ["post", 95] â†’ { id: 95, content: "ìˆ˜ì •ëœ ë‚´ìš©", ... }

[ê²°ê³¼]
  - ë¦¬ìŠ¤íŠ¸ ìºì‹œ(["post", "list", ...])ëŠ” IDë§Œ ê°€ì§€ê³  ìˆìŒ
  - PostItemì€ usePostById(95)ë¡œ ê°œë³„ ì¡°íšŒ
  - byId ìºì‹œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë¯€ë¡œ PostItemì´ ìë™ìœ¼ë¡œ ë¦¬ë Œë”ë§
  - ì–´ë–¤ ë¦¬ìŠ¤íŠ¸ì—ì„œë“  (all, notice, general) ê°™ì€ PostëŠ” ê°™ì€ ìºì‹œ ì°¸ì¡°
```

### ì „í†µì ì¸ ë°©ì‹ê³¼ ë¹„êµ

```
[ì „í†µì ì¸ ë°©ì‹ - ë¦¬ìŠ¤íŠ¸ì— ì „ì²´ ë°ì´í„°]

ìˆ˜ì • ì‹œ:
1. byId ìºì‹œ ì—…ë°ì´íŠ¸
2. list ìºì‹œë„ ìˆœíšŒí•˜ë©° í•´ë‹¹ post ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
3. ë‹¤ë¥¸ category ë¦¬ìŠ¤íŠ¸ë„ ìˆìœ¼ë©´ ê±°ê¸°ë„ ì—…ë°ì´íŠ¸
â†’ ë³µì¡í•˜ê³  ë†“ì¹˜ê¸° ì‰¬ì›€

[ì •ê·œí™” ë°©ì‹ - ë¦¬ìŠ¤íŠ¸ëŠ” IDë§Œ]

ìˆ˜ì • ì‹œ:
1. byId ìºì‹œë§Œ ì—…ë°ì´íŠ¸
â†’ ë! ëª¨ë“  ë¦¬ìŠ¤íŠ¸ì— ìë™ ë°˜ì˜
```

---

## 5. í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½

| í•­ëª© | Offset ê¸°ë°˜ | Cursor ê¸°ë°˜ |
|------|------------|-------------|
| ê¸°ì¤€ì  | ìˆœì„œ ë²ˆí˜¸ (0, 10, 20...) | ë§ˆì§€ë§‰ ë³¸ í•­ëª©ì˜ ê³ ìœ  ID |
| ìƒˆ ë°ì´í„° ì¶”ê°€ ì‹œ | ì¤‘ë³µ/ëˆ„ë½ ë°œìƒ ê°€ëŠ¥ | ë¬¸ì œ ì—†ìŒ |
| ëœë¤ ì ‘ê·¼ | ê°€ëŠ¥ (5í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™) | ë¶ˆê°€ëŠ¥ (ìˆœì°¨ ì ‘ê·¼ë§Œ) |
| DB ì„±ëŠ¥ | OFFSET í´ìˆ˜ë¡ ëŠë¦¼ | ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ ì¼ì • |

**í˜„ì¬ êµ¬í˜„ì˜ í•µì‹¬:**
1. **Cursor = ë§ˆì§€ë§‰ ë³¸ postì˜ id**
2. **`.lt("id", cursor)`** = ì´ë¯¸ ë³¸ ê²ƒ ì´í›„ì˜ ë°ì´í„°ë§Œ
3. **nextCursor = ë§ˆì§€ë§‰ post.id** = ë‹¤ìŒ ìš”ì²­ì˜ ê¸°ì¤€ì 
4. **ë¦¬ìŠ¤íŠ¸ëŠ” IDë§Œ, ì‹¤ì œ ë°ì´í„°ëŠ” byId** = ìºì‹œ ì •ê·œí™”